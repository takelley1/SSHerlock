{% extends "home.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}Jobs{% endblock %}

{% block content %}

<div class="m-5 flex justify-between">

  <div class="ml-5 text-2xl">
  <span>Jobs</span>
  </div>

  <div class="mr-5 mt-1">
  <a href="{% url 'add_object' 'job' %}" class="bg-green-500 hover:bg-green-600 mt-2 p-2 rounded">New Job</a>
  </div>

</div>

{% if output %}

<div class="mx-10 overflow-x-auto rounded-xl border border-white/10 bg-gray-800/70 backdrop-blur shadow">
  <table id="job_list_table" class="w-full text-left divide-y divide-gray-700">
    <thead class="sticky top-0 bg-gray-900/80 backdrop-blur z-10">
      <tr>
        {% for header in column_headers %}
        <th scope="col" class="px-4 py-3 text-xs font-semibold text-gray-300">{{ header }}</th>
        {% endfor %}
        <th scope="col"></th>
      </tr>
    </thead>
    <tbody>
      {% for item in output %}
        <tr onclick="window.location='{% url 'view_job' item.id %}'" class="hover:bg-gray-700 cursor-pointer odd:bg-gray-800 even:bg-gray-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-green-500/50" role="button" tabindex="0">
          {% for field in object_fields %}
          <td>
            <div class="flex items-center gap-2">
              {% with status=item|get_attr:field %}
                {% if status == 'Canceled' or status == 'Completed' or status == 'Context exceeded' or status == 'Failed' or status == 'Pending' or status == 'Running' %}
                  <span class="inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-xs font-medium ring-1 ring-inset {% if status == 'Canceled' %}bg-gray-700 text-gray-200 ring-white/10{% elif status == 'Completed' %}bg-green-600/20 text-green-300 ring-green-600/40{% elif status == 'Context exceeded' or status == 'Failed' %}bg-red-600/20 text-red-300 ring-red-600/40{% elif status == 'Pending' %}bg-yellow-600/20 text-yellow-300 ring-yellow-600/40{% elif status == 'Running' %}bg-blue-600/20 text-blue-300 ring-blue-600/40{% else %}bg-gray-700 text-gray-200 ring-white/10{% endif %}">{{ status }}</span>
                {% endif %}
              {% if field == "created_at" %}
                <span>{{ item|get_attr:field|date:"Y-m-d H:i:s" }}</span>
              {% elif status == 'Canceled' or status == 'Completed' or status == 'Context exceeded' or status == 'Failed' or status == 'Pending' or status == 'Running' %}
                
              {% else %}
                <span class="max-w-[22rem] lg:max-w-none truncate lg:whitespace-pre-wrap break-words">{{ item|get_attr:field }}</span>
              {% endif %}
            </div>
          </td>
          {% endwith %}
          {% endfor %}
          <td>
            <div class="flex space-x-2">
              {% if item.status == "Running" or item.status == "Pending" %}
                <form method="post" action="{% url 'cancel_job' job_id=item.id %}">
                  {% csrf_token %}
                  <button type="submit" class="bg-red-500 hover:bg-red-600 mt-2 p-2 rounded">Cancel</button>
                </form>
              {% endif %}
              {% if item.status == "Canceled" or item.status == "Failed" or item.status == "Context exceeded" %}
                <a class="bg-blue-500 hover:bg-blue-600 mt-2 p-2 rounded" href="{% url 'retry_job' item.id %}">Retry</a>
              {% endif %}
            </div>
          </td>
        </tr>
      {% endfor %}
    <tbody>
  </table>

</div>
{% else %}
  <div class="flex flex-col items-center m-10 p-4 border-4 border-gray-600 rounded-lg">
    <p class="text-lg">No jobs available. You can create a new job by clicking the button above.</p>
  </div>

{% endif %}
{% endblock %}

{% block scripts %}
<script src="{% static 'scripts/job_list.js' %}"></script>
{% endblock %}
