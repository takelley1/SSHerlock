{% extends "home.html" %}
{% block title %}View Job{% endblock %}

{% block content %}
<div class="flex">
    <!-- Job Log Section -->
    <div class="flex-1 mt-5 ml-5 mr-5 mb-5 p-5 bg-black rounded-lg h-svh">
        <div id="job-log">
            <p class="text-white">Job log for job {{ job.id }}</p>
            <!-- Log entries will be appended here by JavaScript -->
        </div>
    </div>

    <!-- Controls and status section -->
    <div class="mt-5 mr-5 pt-3 p-5 h-svh border-gray-300 rounded-lg border-4">
        <div class="flex items-center">
            <p class="font-bold mr-2">Status:</p>
            <span>{{ job.status }}</span>
        </div>

        <form method="post" action="{% url 'cancel_job' job_id=job.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Cancel job</button>
        </form>

        <p>Created at: {{ job.created_at }}</p>
        <p>Started at: {{ job.started_at }}</p>
        <p>Completed at: {{ job.completed_at }}</p>
        <p>Stopped at: {{ job.stopped_at }}</p>
        <p>Duration: {{ job.duration }}</p>
        <p>LLM API: {{ job.llm_api }}</p>
        <p>Bastion host: {{ job.bastion_host }}</p>
        <p>Credentials for bastion host: {{ job.credentials_for_bastion_host }}</p>
        <p>Target host: {{ job.target_hosts_str }}</p>
        <p>Credentials for target host: {{ job.credentials_for_target_hosts }}</p>
        <p>Instructions: {{ job.instructions }}</p>
    </div>
</div>

<script>
    const eventSource = new EventSource("{% url 'stream_job_log' job_id=job.id %}");
    const jobLogDiv = document.getElementById("job-log");

    eventSource.onmessage = function(event) {
        const newLogEntry = document.createElement("p");
        newLogEntry.textContent = event.data;
        jobLogDiv.appendChild(newLogEntry);
        jobLogDiv.scrollTop = jobLogDiv.scrollHeight; // Auto-scroll to the bottom
    };

    eventSource.addEventListener('error', function(event) {
        const errorMessage = document.createElement("p");
        errorMessage.style.color = "red";
        errorMessage.textContent = event.data;
        jobLogDiv.appendChild(errorMessage);
        eventSource.close(); // Stop listening after error
    });

    eventSource.onerror = function() {
        console.error("Error occurred in SSE connection.");
        eventSource.close();
    };
</script>
{% endblock %}
